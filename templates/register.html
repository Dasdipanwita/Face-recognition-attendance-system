{% extends 'base.html' %}

{% block content %}
  <div style="margin-bottom: 2rem;">
    <h2>Register New User</h2>
    <p style="color: var(--gray);">Add a new person to the face recognition system</p>
  </div>

  {% if progress.status == 'idle' or progress.status == 'stopped' or progress.status == 'error' %}
    <div class="recognizer-controls">
      <h3 style="margin-bottom: 1.5rem;">Enter Your Details</h3>

      <form method="POST" action="{{ url_for('register_start') }}" style="max-width: 500px; margin: 0 auto;">
        <div style="margin-bottom: 1.5rem;">
          <label for="name" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--darker);">Full Name:</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="Enter your full name"
            style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease;"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'"
          />
        </div>

        {% if session.get('role') == 'admin' %}
        <div style="margin-bottom: 1.5rem;">
          <label for="role" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--darker);">User Role:</label>
          <select
            id="role"
            name="role"
            style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: white;"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'"
          >
            <option value="user">Regular User</option>
            <option value="admin">Admin</option>
          </select>
          <p style="color: var(--gray); font-size: 0.9rem; margin-top: 0.5rem;">Admin users have full access to the system</p>
        </div>
        {% else %}
        <input type="hidden" name="role" value="user">
        {% endif %}

        <button type="submit" class="btn success" style="width: 100%;">Start Registration</button>
      </form>

      <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)); border-radius: 15px;">
        <h4 style="color: var(--darker); margin-bottom: 1rem;">üìã How Registration Works:</h4>
        <ol style="color: var(--gray); line-height: 2; padding-left: 1.5rem;">
          <li>Enter your full name in the form above</li>
          <li>Click "Start Registration" to begin</li>
          <li>The system will capture 100 images of your face</li>
          <li>Look directly at the camera and move your face slightly</li>
          <li>Wait for the progress bar to reach 100%</li>
          <li>Once complete, you can take attendance!</li>
        </ol>
      </div>
    </div>

  {% elif progress.status == 'starting' or progress.status == 'capturing' %}
    <script>
      // Auto-refresh to update progress
      setTimeout(function() {
        window.location.reload();
      }, 2000);
    </script>

    <div class="recognizer-controls">
      <div style="text-align: center; margin-bottom: 2rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üì∏</div>
        <h3 style="color: var(--darker); margin-bottom: 0.5rem;">Capturing Your Face...</h3>
        <p style="color: var(--gray);">Please look at the camera</p>
      </div>

      <!-- Live Video Feed for Registration -->
      <div style="margin: 1.5rem auto; max-width: 800px; text-align: center;">
        <img src="{{ url_for('registration_feed') }}"
             style="width: 100%; max-width: 640px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); border: 3px solid var(--primary);"
             alt="Live Registration Camera Feed">
      </div>

      <div style="background: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span style="font-weight: 600; color: var(--darker);">Progress: {{ progress.current }}/{{ progress.total }}</span>
          <span style="font-weight: 600; color: var(--primary);">{{ (progress.current / progress.total * 100) | int }}%</span>
        </div>

        <div style="width: 100%; height: 30px; background: var(--border); border-radius: 15px; overflow: hidden;">
          <div style="width: {{ (progress.current / progress.total * 100) | int }}%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); transition: width 0.3s ease;"></div>
        </div>
      </div>

      <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 12px; margin-bottom: 1.5rem;">
        <p style="color: var(--darker); font-weight: 500; margin-bottom: 0.5rem;">Registering: {{ progress.name }}</p>
        <p style="color: var(--gray); font-size: 0.9rem;">Keep your face in front of the camera and move it slightly</p>
      </div>

      <form method="POST" action="{{ url_for('register_stop') }}" style="text-align: center;">
        <button type="submit" class="btn danger">Cancel Registration</button>
      </form>
    </div>

  {% elif progress.status == 'saving' %}
    <div class="recognizer-controls" style="text-align: center;">
      <div style="font-size: 4rem; margin-bottom: 1rem;">üíæ</div>
      <h3 style="color: var(--darker); margin-bottom: 0.5rem;">Saving Your Data...</h3>
      <p style="color: var(--gray);">Please wait while we process your information</p>
      <script>
        setTimeout(function() {
          window.location.reload();
        }, 2000);
      </script>
    </div>

  {% elif progress.status == 'completed' %}
    <div style="text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border-radius: 15px;">
      <div style="font-size: 5rem; margin-bottom: 1rem;">‚úÖ</div>
      <h2 style="color: var(--success); margin-bottom: 1rem;">Registration Successful!</h2>
      <p style="color: var(--gray); font-size: 1.2rem; margin-bottom: 2rem;">
        Welcome, <strong>{{ progress.name }}</strong>! You have been successfully registered.
      </p>

      <div style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; display: inline-block;">
        <p style="color: var(--darker); font-weight: 600; margin-bottom: 1rem;">‚ú® What's Next?</p>
        <ul style="list-style: none; padding: 0; color: var(--gray); text-align: left;">
          <li style="margin-bottom: 0.5rem;">‚úì Your face has been added to the system</li>
          <li style="margin-bottom: 0.5rem;">‚úì You can now use the Camera page to mark attendance</li>
          <li style="margin-bottom: 0.5rem;">‚úì The system will recognize you automatically</li>
        </ul>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a href="{{ url_for('recognizer_control') }}" class="btn success">Go to Camera</a>
        <a href="{{ url_for('register_page') }}" class="btn secondary">Register Another User</a>
        <a href="{{ url_for('home') }}" class="btn secondary">Back to Home</a>
      </div>
    </div>
  {% endif %}

  <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); border-radius: 12px;">
    <h4 style="color: var(--danger); margin-bottom: 0.5rem;">‚ö†Ô∏è Important Notes:</h4>
    <ul style="color: #991b1b; line-height: 1.8; padding-left: 1.5rem;">
      <li>Ensure good lighting for better face detection</li>
      <li>Look directly at the camera during registration</li>
      <li>Don't move too quickly - the system needs clear images</li>
      <li>Registration takes about 30-60 seconds to complete</li>
      <li>Each person can only register once with the same name</li>
    </ul>
  </div>
{% endblock %}
