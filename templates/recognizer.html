{% extends 'base.html' %}

{% block content %}
  <div class="recognizer-controls">
    <h2>Face Recognition Camera</h2>
    <p style="color: var(--gray); margin: 0;">The camera will stream from your device; recognition happens on the server.</p>

    <div style="margin-top: 1.5rem;">
      <button id="start-camera" class="btn success">Start Camera</button>
      <button id="stop-camera" class="btn danger" disabled>Stop Camera</button>
      <a href="{{ url_for('attendance_today') }}" class="btn secondary" style="margin-left: 1rem;">View Attendance</a>
    </div>

    <div id="status" class="status stopped" style="margin-top: 1rem;">● Camera Stopped</div>
  </div>

  <div style="margin-top: 2rem;">
    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px;">
      <p style="color: var(--darker); font-weight: 600; margin: 0;">Verifying Face for: <strong style="color: #3b82f6;">{{ username }}</strong></p>
      <p style="color: var(--gray); font-size: 0.9rem; margin: 0.5rem 0 0 0;">The camera stops automatically after a match or mismatch.</p>
    </div>

    <!-- Live Video Feed -->
    <div style="margin: 1.5rem auto; max-width: 800px;">
      <video id="video" width="640" height="480" autoplay playsinline style="border-radius: 10px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); border: 3px solid var(--primary);"></video>
      <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startButton = document.getElementById('start-camera');
    const stopButton = document.getElementById('stop-camera');
    const statusDiv = document.getElementById('status');
    let stream = null;
    let intervalId = null;

    function updateStatus(message, isRunning = false) {
      statusDiv.textContent = `● ${message}`;
      statusDiv.className = isRunning ? 'status running' : 'status stopped';
    }

    function showPopup(message, type) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      `;

      const popup = document.createElement('div');
      const isSuccess = type === 'success';
      const bgColor = isSuccess ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)';
      const icon = isSuccess ? '✓' : '✗';

      popup.style.cssText = `
        background: white;
        padding: 3rem;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
        width: 90%;
      `;

      popup.innerHTML = `
        <div style="
          width: 80px;
          height: 80px;
          background: ${bgColor};
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 1.5rem auto;
        ">
          <span style="font-size: 3rem; color: white; font-weight: bold;">${icon}</span>
        </div>
        <h2 style="color: #0f172a; font-size: 1.8rem; margin-bottom: 1rem; font-weight: 700;">
          ${isSuccess ? 'Verification Successful!' : 'Verification Failed!'}
        </h2>
        <p style="color: #64748b; font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">${message}</p>
        <button onclick="closePopup()" style="
          background: ${bgColor};
          color: white;
          border: none;
          padding: 1rem 3rem;
          font-size: 1.1rem;
          font-weight: 600;
          border-radius: 12px;
          cursor: pointer;
        ">
          OK
        </button>
      `;

      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }

    function closePopup() {
      const overlay = document.querySelector('div[style*="z-index: 9999"]');
      if (overlay) {
        overlay.remove();
      }
    }

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(mediaStream => {
          stream = mediaStream;
          video.srcObject = stream;
          startButton.disabled = true;
          stopButton.disabled = false;
          updateStatus('Camera Running', true);
          intervalId = setInterval(sendFrame, 300);
        })
        .catch(err => {
          console.error('Error accessing camera:', err);
          alert('Unable to access camera. Please grant permission and ensure a camera is connected.');
        });
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.srcObject = null;
      startButton.disabled = false;
      stopButton.disabled = true;
      updateStatus('Camera Stopped', false);
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    function sendFrame() {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const data = canvas.toDataURL('image/jpeg');

      fetch("{{ url_for('detect') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ image: data })
      })
        .then(response => response.json())
        .then(data => {
          if (data.match) {
            showPopup(data.message || 'Attendance recorded', 'success');
            stopCamera();
          } else if ((data.message || '').toLowerCase().includes('face not recognized')) {
            showPopup(data.message || 'Face not recognized', 'error');
            stopCamera();
          } else if (data.message) {
            updateStatus(data.message, true);
          }
        })
        .catch(error => {
          console.error('Error sending frame:', error);
          updateStatus('Error communicating with server', false);
          stopCamera();
        });
    }

    startButton.addEventListener('click', startCamera);
    stopButton.addEventListener('click', stopCamera);
  </script>
{% endblock %}
